<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="stylesheet" href="https://samuelg900.github.io/ElsiliasKitchen/404.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
<title>My Order</title>

</head>

<body>

<!-- <h1> 404 Page.... to do later</h1> -->


    <div id="qrcode-div-id">
        <h2>Elsilia's Kitchen Order</h2>
        <div id="qrcode"></div>
    </div>

  <div id="cart_contents_id">
        <div class="cartContent">
            <div class="cartItems" id="cartItemsId">
            </div>
        </div>
    </div>

<script>
    const allItems = [];
    function getJsonData() {
    fetch('https://samuelg900.github.io/ElsiliasKitchen/items.json')
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            // allItems = data;

            data.forEach(i =>{allItems.push(i);})
             getItemsNames();
             renderCart();
             getQRCode();

        })
        .catch(error => {
            console.error('There was a problem with the fetch operation:', error);
        })

}
</script>

    <script>

        function getQRCode(){
             document.getElementById("qrcode").innerHTML = '';

            let qrcode = new QRCode(document.getElementById("qrcode"), {
                text: window.location.href.replace("home.html/", "home.html"),
                width: 256,
                height: 256,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.L
            });

        }

        let cart = [];
        
        function renderCart() {
            if (cart.length === 0)
                return;

            const cartDiv = document.getElementById('cartItemsId');
            cartDiv.innerHTML = ''; // clear old items

            cart.forEach(item => {

                // Create the outer container
                let container = document.createElement('div');
                container.className = 'cartItemContainter';

                // Left picture div
                let left = document.createElement('div');
                left.className = 'leftpic';

                let img = document.createElement('img');
                img.src = item.image_url;
                img.alt = item.name;

                let img2 = document.createElement('img');
                img2.src = item.image_url;


                if (item.pan_size[0] === 'H') {
                    img2.classList.add('blurred');
                    left.appendChild(img2);
                }
                left.appendChild(img);

                // Right name/qty div
                let right = document.createElement('div');
                right.className = 'rightname';
                right.style.position = "relative";

                let nameP = document.createElement('p');
                nameP.textContent = item.name;

                let pane_size = document.createElement('p');
                pane_size.classList.add('pan_text');

                pane_size.textContent = item.pan_size[0] === 'H' ? "Half Pan" : "Full Pan";

                let qtyP = document.createElement('p');
                qtyP.textContent = `Qty: ${item.quantity}`;
                qtyP.style.fontSize = "14px";
                qtyP.style.position = "absolute";
                qtyP.style.bottom = "0";

                right.appendChild(nameP);
                right.appendChild(pane_size);
                right.appendChild(qtyP);

                // Put it all together
                container.appendChild(left);
                container.appendChild(right);

                // Add to cart div
                cartDiv.appendChild(container);
            });

        }

    </script>

    <script>

function getItemsNames(){
    cart.forEach(item =>{

        const it = allItems.find(i => i.id === item.id);

        if(it){
                item.name = it.name_english;
                item.image_url = "https://samuelg900.github.io/ElsiliasKitchen/" + it.image_link;
        }else{//not found
                return false;
        }

    });

    return true;
}




window.onload = function() {

    //  const str = "https://samuelg900.github.io/ElsiliasKitchen/home.html/#2/00202f1/10203h1/@"
    const str = window.location.href;
    // const hash = window.location.hash; 
    let hash = str.slice(55, str.length);
    // console.log(h);
    // console.log(str);
    const regex = /^#(\d+)\/((?:\d{5}[fh]\d\/)+)@$/;
    const match = regex.exec(hash);

if (match) {
        const count = parseInt(match[1], 10);   // number of items
        const itemsStr = match[2];              // whole "00100f1/.../"
        const items = itemsStr.split('/').filter(Boolean); // ["00100f1", "00101f1", "10101h1"]
    const blank_name = "";
    const image_url = "";
        // ✅ Build summary
        let summaryHtml = `<h2>Order Summary</h2><ul>`;
        items.forEach(item => {
            let id = parseInt(item.slice(0,5));    // "00100"
            if(id > 10000)
                id -= 10000;
            const pan_size = item[5] === 'f' ? "Full Pan" : "Half Pan";
            const quantity = item[6];           // "1"
            summaryHtml += `<li>Item ID: ${id}, Size: ${pan_size}, Qty: ${quantity}</li>`;
        cart.push({id, blank_name, pan_size, quantity, image_url});
        
        });
        summaryHtml += `</ul>`;

            getJsonData();

//         if(getItemsNames()===false){
           
//  document.body.innerHTML = "<h2>Page not found</h2>";
//             return;
//         }
//         else{
//         }


        // document.body.innerHTML = summaryHtml;

        // Optional: sanity check — does count match actual number of items?
        if (items.length !== count) {
            document.body.innerHTML = "<h2>Invalid order link.</h2>";
        }
    } else {
        // ❌ Not a valid QR link → show default 404
        document.body.innerHTML = "<h2>Page not found</h2>";
    }
}
</script>

</body>

</html>